

<!DOCTYPE html>
<html>

<head>
  <title>Arco Research &amp; Documentation</title>
  <meta charset='utf-8'>

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/highlight-default.css">
  <link rel="stylesheet" href="/css/style.css">

  <link rel="icon" type="image/png"  href="/images/icon.png">
</head>

<body>
  <div id="content" class="container" style="padding-top: 15px">


<link rel="stylesheet" href="/shapes/css/style.css">

<div class="box">
  <a href="/">
    <img src="/shapes/images/shapes-logo.png"
         style="padding: 0 25px" />
  </a>
  <h1 style="display: inline; font-weight: bold; font-size: 2.3em; padding-top: 10px">
    <a href="/shapes" style="color: inherit">Shapes</a>
  </h1>
</div>

<hr style="border: 1px solid #333333">


<h1>Integrating MbientLab MetaMotionR sensors with Python</h1>
<nav id="TableOfContents"></nav>

<div class="recipe-content">
  <h1 id="overview">Overview</h1>
<p>MbientLab is a manufacture of different wearable devices, an example of these
are the <strong>Meta</strong> sensors family, which is formed by different wearable devices like
<strong>MetaTracker</strong>, <strong>MetaMotionC</strong> and <strong>MetaMotionR</strong>. The Meta family devices are formed
by different sensors, like Accelerometers, Gyroscopes, Barometes, etc&hellip; In this case,
we are going to see how to use a Python library for the MetaMotionR, which enable the user
to read the sensors of this device. The measures that can be read with the Library are
the <strong>acceleration</strong>, <strong>motion</strong>, <strong>tap</strong>, <strong>step counter</strong> by an Accelerometer and
the <strong>rotation</strong> by a Gyroscope.</p>
<h1 id="ingredients">Ingredients</h1>
<p>In order to follow the next recipe you will need the this ingredients:</p>
<ul>
<li>A <strong>MetaMotionR</strong> device</li>
<li>The linux packages <code>bluez</code>, <code>build-essential</code>, <code>libboost-all-dev</code>, <code>libbluetooth-dev</code> which
enables the Bluetooth communication and provides the necessary compilers</li>
<li>The <code>metawear</code> package, a library created for <strong>MbientLab</strong> to read sensors measures</li>
<li>The <code>bleak</code> library in order to discover BLE devices</li>
<li>The <code>metamotion</code> library available in <a href="https://uclm-arco.github.io/debian/">ARCO&rsquo;s package repository</a></li>
<li>Basic knwoledge of <code>Python3</code> and <code>Linux</code></li>
</ul>
<p>In order to install al the dependencies you must execute the next commands</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>sudo apt install bluez build-essential libboost-all-dev libbluetooth-dev
pip3 install metawear --upgrade
pip3 install bleak
sudo apt install metamotion</pre>
</div>
<p>In the following sections, we are going to explain the main funcionalities of the library,
read a value from a sensor, attach a handler to a value produced by the sensor and create
logs of data that will be downloaded lately.
Almost every measure of the sensor can be readed, but not all the measures support the use of a
handler.</p>
<h1 id="connecting-and-reading-data-from-the-device">Connecting and Reading data from the device</h1>
<p>In this section, we are going to explain how you can read the battery from
a MetaMotionR board. The first step is import the <code>metamotion</code> library in the
following way.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>#!/usr/bin/python3

from metamotion import MetaMotion</code></pre>
</div>
<!-- raw HTML omitted -->
<pre><code>  Warning!
</code></pre>
<!-- raw HTML omitted -->
<p>Once you import the library you must instantiate your chip. In order to do that
you must call the constructor <code>MetaMotion</code> with the <strong>MAC address</strong> of the
chip, which can be observer in the label of the device. Once the sensor is instantiated,
call the <code>connect()</code> method in order to establish the Bluetooth connection</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()</code></pre>
</div>
<p>Finally you can read any value of the chip, in this case we are going to read the remanent percentage
battery invoking the method <code>read_battery</code> of the class. This method returns a struct that is formed
by two fields, <code>voltage</code>, which represents the voltage that receives the chip, and <code>battery</code> which
is the percentage of battery that the device has.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>measure = sensor.read_battery()
print(measure.battery)</code></pre>
</div>
<p>Before the end of the program is important to invoke the <code>disconnect</code> method, in order
to close the communication.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.disconnect()</code></pre>
</div>
<p>The full code is listed here below</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>#!/usr/bin/python3

from metamotion import MetaMotion

sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()

measure = sensor.read_battery()
print(measure.battery)

sensor.disconnect()</code></pre>
</div>
<!-- raw HTML omitted -->
<pre><code>  Warning!
</code></pre>
<!-- raw HTML omitted -->
<h1 id="read-a-measure-from-a-sensor">Read a measure from a sensor</h1>
<p>Like it was said before, the MetaMotionR device is formed by several sensors. The most important sensors,
and those to which the library gives access to, are the <strong>Acceleromter</strong> and the <strong>Gyro</strong> sensor. In order
to access to the measures of this sensors, a <code>MetaMotion</code> instance has two attributes representing it,
<code>accelerometer</code> and <code>gyroscope</code>. Following, we are going to see an example in which we are going to read
the <strong>acceleration</strong>.</p>
<p>In order to read the acceleration, the first step is to active and initialize the accelerometer.
For this purpose you must invoke the method <code>setup_accelerometer</code> with the aim of
active and initialize the accelerometer sensor. If you don&rsquo;t do this, and you try to
access the <code>accelerometer</code> sensor, an exception will be raised.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.setup_accelerometer()</code></pre>
</div>
<p>Once initialized the sensor, you can read the acceleration invoking the method form the <code>accelerometer</code>
<code>read_acceleration</code>, which returns the acceleration calculated by the sensor in <strong>G</strong> units.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.accelerometer.read_acceleration()</code></pre>
</div>
<p>The full code is listed below</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>#!/usr/bin/python3

from metamotion import MetaMotion

sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()
sensor.setup_accelerometer()

measure = sensor.accelerometer.read_acceleration()
print(measure)

sensor.disconnect()</code></pre>
</div>
<h1 id="add-a-handler-to-a-measure">Add a handler to a measure</h1>
<p>With the MetaMotion library you can read any values produced by the sensor, but this library
also provides the funcionality to subscribe to a measure and attach a handler. In this way,
if the sensor which we are subscribed send a value, the handler will be executed and will
process the data with the user function.</p>
<p>In this section we are going to see an example where we add a handler to an accelertion sample.</p>
<p>The first step is to declare the handler that will process the data, in this case the handler
is going to print the data.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>def handler(data):
    print(f&#34;The acceleration is: {data.x} {data.y} {data.z}&#34;)</code></pre>
</div>
<p>Once the handler is defined, you must attach it to the acceleration produced by the sensor, so that
when an acceleration measure is received, the user function will be executed. The acceleration is
produced by an <strong>accelerometer</strong> in the <strong>MetaMotionR</strong> device, for this reason, to add the handler
you must call the <code>on_acceleration</code> method of the <code>accelerometer</code> attribute in your instance of the
<code>MetaMotion</code> class. To avoid the end of the program, the method <code>wait_until_break</code> must be called.
The full program can be seen below.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>#!/usr/bin/python3

from metamotion import MetaMotion

def handler(data):
    print(f&#34;The acceleration is: {data.x} {data.y} {data.z}&#34;)

sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()

measure = sensor.accelerometer.on_acceleration(handler)
sensor.wait_until_break()

sensor.disconnect()</code></pre>
</div>
<h1 id="using-a-logger">Using a logger</h1>
<p>An interesting funcionality of the MetaMotionR devices is the posibility to create loggers. A logges
make the users ables to register a set of data from a sensor in the device, and lately download
all this data, avoiding maintaining a continuous streaming.
This is very useful if you don&rsquo;t want to communicate with the sensor in each measure. In
the following example, we are going to create a logger for a <strong>rotation</strong> measure</p>
<p>As in all previous examples, the first step is to made the connection with the sensor. Once the connection
is made, and beacuse we are going to log a measure from the <strong>Gyro</strong>, we must invoke the method <code>setup_gyroscope</code> and <code>setup_logger</code>
from the <code>gyroscope</code> attribute to initialize the sensor and the logger. After that, invoke the method <code>start_logging</code>
in order to start to save the data. Following, you can disconnect from the sensor until you want to download the data.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.gyroscope.setup_gyroscope()
sensor.gyroscope.setup_logger()
sensor.start_logging()
sensor.disconnect()</code></pre>
</div>
<p>Once you want to download data, connect to the sensor again and invoke the methods <code>stop_logging</code>
in order to stop registering data.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.stop_logging()</code></pre>
</div>
<p>At this point, there is a problem, our instance doesn&rsquo;t know which is the status of the sensor, which loggers
were created, and which signal were registering. To solve this problem, can be used the method
<code>sync_host_with_device</code>, that synchronize our instance with the actual status of our MetamotionR device.
Now our instance knows which logger exists, but doesn&rsquo;t knows which signals were subscribed, for this reason,
and to download all data, you must invoke the method <code>subscribe_anonymous_datasignals</code>. Once our instance is prepared,
download the data is as simple as call the method <code>download_logs</code> to get all the data from the device, and
<code>wait_until_download_completed</code>, to avoid the finish of the program until all the data is downloaded. Finally,
the downloaded data is in a list, in this case in the attribute <code>rotation_log</code> from the <code>gyroscope</code>.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.stop_logging()
sensor.gyroscope.subscribe_logged_data()
sensor.download_logs()

sensor.gyroscope.wait_until_download_completed()
print(&#34;The rotation is &#34;, sensor.gyrocope.rotation_log)</code></pre>
</div>
<p>Finally, is needed to clean the logger created in the device before disconnection.</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>sensor.clean()
sensor.disconnect()</code></pre>
</div>
<p>The full code is listed bellow</p>
<div class="app-skin">
  <div class="filename">
    
      snippet.py
    
  </div>
  
  <pre><code class='language-py'>#!/usr/bin/python3

import sys
import time
from metamotion import MetaMotion

sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()

sensor.gyroscope.setup_gyroscope()
sensor.gyroscope.setup_logger()
sensor.start_logging()
sensor.disconnect()

time.sleep(4) #Wait 4 seconds to let the sensor log data

sensor = MetaMotion(&#34;E9:75:41:AF:11:AE&#34;)
sensor.connect()

sensor.stop_logging()
sensor.sync_host_with_device()
sensor.subscribe_anonymous_datasignals()

sensor.download_logs()
sensor.wait_until_download_complete()
print(&#34;The rotation is &#34;, sensor.gyroscope.rotation_log)

sensor.clean()
sensor.disconnect()</code></pre>
</div>
<p>You can use as many logs as you want, but you must follow the next workflow:</p>
<ol>
<li>Connect the sensor</li>
<li>Setup the necessary logger in their respective sensor from the chip</li>
<li>Start the logging</li>
<li>Wait a desired amount of time</li>
<li>Connect with the sensor again</li>
<li>Stop the logging</li>
<li>Sync the client with the device status</li>
<li>Subscribe to anonymous datasignals</li>
<li>Download the logs</li>
<li>Wait for each sensor to download its log data</li>
<li>Clean and disconnect from the sensor</li>
</ol>
<h1 id="metamotion-api">MetaMotion API</h1>
<p>For more information you can see the API reference where you can find how to read
all the measures available and the different methods to attach handlers:</p>
<ul>
<li><a href="/api/bosch-sensor/">MetaMotion API Reference</a></li>
</ul>

</div>



    </div> 

    <footer class="footer">
      <div class="container text-center">
        <a href="http://www.arcoresearch.com">ARCO Research Group</a> |
        <a href="/">Docs</a>&nbsp; - &nbsp;made with
        <a href="https://gohugo.io">Hugo</a> ·
        <a href="http://getbootstrap.com">Bootstrap</a>
      </div>
    </footer>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>


