

<!DOCTYPE html>
<html>

<head>
  <title>Arco Research &amp; Documentation</title>
  <meta charset='utf-8'>

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.css">
  <link rel="stylesheet" href="/css/highlight-default.css">
  <link rel="stylesheet" href="/css/style.css">

  <link rel="icon" type="image/png"  href="/images/icon.png">
</head>

<body>
  <div id="content" class="container" style="padding-top: 15px">


<link rel="stylesheet" href="/shapes/css/style.css">

<div class="box">
  <a href="/">
    <img src="/shapes/images/shapes-logo.png"
         style="padding: 0 25px" />
  </a>
  <h1 style="display: inline; font-weight: bold; font-size: 2.3em; padding-top: 10px">
    <a href="/shapes" style="color: inherit">Shapes</a>
  </h1>
</div>

<hr style="border: 1px solid #333333">


<h1>Google Assistant on the Voice Bonnet</h1>
<nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#ingredients">Ingredients</a></li>
    <li><a href="#raspberry-pi-setup">Raspberry Pi Setup</a></li>
    <li><a href="#blinka-setup">Blinka Setup</a>
      <ul>
        <li><a href="#check-i2c-and-spi">Check I2C and SPI</a></li>
      </ul>
    </li>
    <li><a href="#audio-setup">Audio Setup</a>
      <ul>
        <li><a href="#install-voicecard-software">Install Voicecard software</a></li>
        <li><a href="#headphonespeaker-test">Headphone/Speaker Test</a></li>
        <li><a href="#microphone-test">Microphone Test</a></li>
      </ul>
    </li>
    <li><a href="#google-setup">Google Setup</a>
      <ul>
        <li><a href="#project-creation">Project Creation</a></li>
        <li><a href="#device-registration">Device Registration</a></li>
        <li><a href="#google-assistant-api-setup">Google Assistant API Setup</a></li>
        <li><a href="#enabling-permissions">Enabling Permissions</a></li>
      </ul>
    </li>
    <li><a href="#device-setup">Device Setup</a>
      <ul>
        <li><a href="#generating-an-oauth-token">Generating an OAuth Token</a></li>
      </ul>
    </li>
    <li><a href="#usage">Usage</a></li>
  </ul>
</nav>

<div class="recipe-content">
  <h2 id="overview">Overview</h2>
<p>You can set up your own Google Assistant with just a Raspberry Pi and an Adafruit Voice Bonnet. You through setting up the Google Assistant API you can install a few library, enable permissions and get the Google Assistant running on the RPi. Now you can ask Google what you want with the simple push of a button.</p>
<h2 id="ingredients">Ingredients</h2>
<p>In order to follow this recipe you will need:</p>
<ul>
<li>A Raspberry Pi 4 or <strong>RPi4</strong></li>
<li>A Adafruit Voice Bonnet</li>
<li>Two Mono Enclosed Speaker or headphones</li>
<li>A Google account</li>
</ul>
<h2 id="raspberry-pi-setup">Raspberry Pi Setup</h2>
<p>The first step is perform an update/upgrade and install the cross-platform package manager <code>pip</code>:</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ sudo apt-get update
pi@raspberrypi:~ $ sudo apt-get -y upgrade

pi@raspberrypi:~ $ sudo apt-get install -y python3-pip
pi@raspberrypi:~ $ sudo pip3 install --upgrade setuptools</pre>
</div>
<h2 id="blinka-setup">Blinka Setup</h2>
<p>Blinka is a CirciutPython library compatibility layer. It requires just a few commands to run:</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ cd ~
pi@raspberrypi:~ $ sudo pip3 install --upgrade adafruit-python-shell
pi@raspberrypi:~ $ wget https://raw.githubusercontent.com/adafruit/Raspberry-Pi-Installer-Scripts/master/raspi-blinka.py
pi@raspberrypi:~ $ sudo python3 raspi-blinka.py</pre>
</div>
<p>When it finishes, it will ask you if you would like to reboot. Choose <strong>yes</strong></p>
<p>You install DotStart library to controlling the 3 on-board DotStar LEDs:</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ pip3 install --upgrade adafruit-circuitpython-dotstar adafruit-circuitpython-bmp280</pre>
</div>
<h3 id="check-i2c-and-spi">Check I2C and SPI</h3>
<p>To verify that the script had enable I2C and SPI, run the following command:</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ ls /dev/i2c* /dev/spi*</pre>
</div>
<p>You sould see the next response:</p>

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/check_i2c_spi.png' width='' height=''/>


<p>If you need another hardware SPI port, you can enable it by adding the line <code>dtoverlay=spi1-3cs</code> to the bottom of <code>boot/config.txt</code> and rebooting.</p>
<h2 id="audio-setup">Audio Setup</h2>
<h3 id="install-voicecard-software">Install Voicecard software</h3>
<p>You run <code>sudo i2cdetect -y 1</code> and you should see an entry under 1a. If you already installed software the number appear as UU, as show in the image.

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/voicecard.png' width='' height=''/>

</p>
<p>At the commands like run:
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ sudo apt-get install -y git
pi@raspberrypi:~ $ git clone https://github.com/HinTak/seeed-voicecard
pi@raspberrypi:~ $ cd seeed-voicecard
pi@raspberrypi:~ $ git checkout v5.5
pi@raspberrypi:~ $ sudo ./install.sh</pre>
</div></p>
<p>When it finishes reboot and on reboot run <code>sudo aplay -l</code> to list all sound cards. You should see it at the bottom:

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/list_sound_cards.png' width='' height=''/>

</p>
<p>You can user <code>alsamixer</code> to adjust the volume. Select the card with <strong>F6</strong>

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/alsamixer.png' width='' height=''/>

</p>
<h3 id="headphonespeaker-test">Headphone/Speaker Test</h3>
<p>Make sure the audio on/off switch is set to on. Run <code>speaker-test -c2</code> and you will hear white noise.</p>
<h3 id="microphone-test">Microphone Test</h3>
<p>Run <code>sudo arecord -f cd -Dhw:2 | aplay -Dhw:2</code>. Then speak to hear yourself echoed.</p>
<h2 id="google-setup">Google Setup</h2>
<h3 id="project-creation">Project Creation</h3>
<p>Start by going to <a href="https://console.actions.google.com/">https://console.actions.google.com/</a> and create <strong>New Project</strong>.</p>
<p>Enter a project name such as <strong>Google Assistant BrainCraft</strong> and click on <strong>Create Project</strong>.</p>

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/create_project.png' width='' height=''/>


<p>At the bottom of the page, click on the link to go to device registration.

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/device_registration.png' width='' height=''/>

</p>
<h3 id="device-registration">Device Registration</h3>
<p>Click the <strong>register model</strong> button. Fill in the fields with the requested information. For device type, choose Speaker. Click the register moddel button.

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/register_model.png' width='' height=''/>

</p>
<p>Click <strong>Download OAuth 2.0 credentials</strong> and save the JSON file as client_secret.json. You will upload this to your Raspberry Pi in a later step. Click Next. Under traits, click <strong>All 7 traits</strong> and then click <strong>Save Traits</strong>.</p>

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/traits.png' width='' height=''/>


<h3 id="google-assistant-api-setup">Google Assistant API Setup</h3>
<p>Go to the Google Developers Console to enable the API at <a href="https://console.developers.google.com/apis/api/embeddedassistant.googleapis.com/overview">https://console.developers.google.com/apis/api/embeddedassistant.googleapis.com/overview</a>. Click on the project selector at the top. Then, select the project.

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/api_project.png' width='' height=''/>

</p>
<p>Click on the <strong>Enable button</strong>. Once it is enabled, you will be taken to the Overview Screen. Click on the <strong>Credentials</strong> tab on the left and then click the <strong>Configure Consent Screen</strong> button on the right. For user type, select <strong>External</strong> and click create.</p>
<p>Then, enter an application name, this is is the name that will appear on the permissions screen. Select a support email, this is the email that will appear when you click on the application name on the permissions screen. Finally, click save.</p>
<h3 id="enabling-permissions">Enabling Permissions</h3>
<p>Go to activity controls at <a href="https://myaccount.google.com/activitycontrols">https://myaccount.google.com/activitycontrols</a>. Make sure web and app activity is on. Also make sure to select the include chrome history and activity from sites, apps, and devices that use google services; this is the first checkbox. An additional dialog may pop up asking you to confirm, click the <strong>Turn on</strong> button.</p>
<h2 id="device-setup">Device Setup</h2>
<p>Upload the <strong>client_secret.json</strong> credentials file and place it in your home directory on RPi. Next, you are going to check that you have the required packages and setup a virtual environment</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ cd ~
pi@raspberrypi:~ $ sudo apt-get update
pi@raspberrypi:~ $ sudo apt-get install python3-dev python3-venv
pi@raspberrypi:~ $ python3 -m venv env
pi@raspberrypi:~ $ env/bin/python -m pip install --upgrade pip setuptools wheel
pi@raspberrypi:~ $ source env/bin/activate</pre>
</div>
<p>Install the Authorization library:
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ sudo apt-get install portaudio19-dev libffi-dev libssl-dev
pi@raspberrypi:~ $ python -m pip install --upgrade google-assistant-sdk[samples]
pi@raspberrypi:~ $ python -m pip install --upgrade google-auth-oauthlib[tool]</pre>
</div></p>
<h3 id="generating-an-oauth-token">Generating an OAuth Token</h3>
<p>Run the following command:</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ google-oauthlib-tool --scope https://www.googleapis.com/auth/assistant-sdk-prototype --save --headless --client-secrets ~/client_secret.json</pre>
</div>
<p>The script should provide a URL to visit to generate the token. Go ahead and click on the <strong>Advanced</strong> link. After that, it will come up with a confirmation dialog, go ahead and click on <strong>Allow</strong>. Finally, you will be given an Authorization Code; click on the <strong>Copy</strong> icon and paste the authorization on your terminal. Code back into the script and the token will be generated and saved.</p>
<h2 id="usage">Usage</h2>
<p>First make sure you&rsquo;re in the virtual environment. If you aren&rsquo;t run <code>source env/bin/activate</code>.</p>
<p>Next, run the following command</p>
<div class="app-skin shell">
  <div class="filename">console</div>
  
  <pre class=shell>pi@raspberrypi:~ $ wget https://raw.githubusercontent.com/adafruit/Adafruit_Learning_System_Guides/master/BrainCraft_Google_Assistant/gv_buttontotalk.py</pre>
</div>
<p>And run the script, type <code>python3 gv_buttontotalk.py</code>. At the beggining the leds are red so click the button and the leds should turn green, meaning it&rsquo;s waiting for you to give it ask a question.</p>

  
  



  
  









<img src='/shapes/images/google_assistant_on_voice_bonnet/usage.png' width='' height=''/>



</div>



    </div> 

    <footer class="footer">
      <div class="container text-center">
        <a href="http://www.arcoresearch.com">ARCO Research Group</a> |
        <a href="/">Docs</a>&nbsp; - &nbsp;made with
        <a href="https://gohugo.io">Hugo</a> ·
        <a href="http://getbootstrap.com">Bootstrap</a>
      </div>
    </footer>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>


